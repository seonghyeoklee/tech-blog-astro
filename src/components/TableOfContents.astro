---
interface Props {
  headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;
const filteredHeadings = headings.filter(h => h.depth >= 2 && h.depth <= 3);
---

{filteredHeadings.length > 0 && (
  <aside class="toc-sidebar">
    <nav class="toc">
      <h4 class="toc-title">목차</h4>
      <ul class="toc-list">
        {filteredHeadings.map((heading) => (
          <li class={`toc-item depth-${heading.depth}`}>
            <a href={`#${heading.slug}`}>{heading.text}</a>
          </li>
        ))}
      </ul>
    </nav>
  </aside>
)}

<style>
  .toc-sidebar {
    display: none;
  }

  @media (min-width: 1280px) {
    .toc-sidebar {
      display: block;
      position: fixed;
      top: 100px;
      right: calc((100vw - 960px) / 2 - 280px);
      width: 240px;
      max-height: calc(100vh - 150px);
      overflow-y: auto;
    }
    .toc {
      padding: 1em;
      border-left: 2px solid rgb(var(--gray-light));
    }
    .toc-title {
      margin: 0 0 0.75em 0;
      font-size: 0.8em;
      color: rgb(var(--gray));
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .toc-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .toc-item {
      margin: 0.5em 0;
    }
    .toc-item a {
      color: rgb(var(--gray));
      text-decoration: none;
      font-size: 0.85em;
      line-height: 1.4;
      transition: color 0.2s ease;
      display: block;
    }
    .toc-item a:hover,
    .toc-item a.active {
      color: var(--accent);
    }
    .depth-3 {
      padding-left: 0.8em;
    }
    .depth-3 a {
      font-size: 0.8em;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tocLinks = document.querySelectorAll('.toc-item a');
    const headings = Array.from(tocLinks).map(link => {
      const id = link.getAttribute('href')?.slice(1);
      return document.getElementById(id || '');
    }).filter(Boolean);

    function updateActiveLink() {
      const scrollY = window.scrollY;
      let currentIndex = 0;

      headings.forEach((heading, index) => {
        if (heading && heading.offsetTop - 120 <= scrollY) {
          currentIndex = index;
        }
      });

      tocLinks.forEach((link, index) => {
        if (index === currentIndex) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    }

    window.addEventListener('scroll', updateActiveLink, { passive: true });
    updateActiveLink();
  });
</script>
