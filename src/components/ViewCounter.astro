---
interface Props {
  slug: string;
  increment?: boolean;
}

const { slug, increment = false } = Astro.props;
---

<span class="view-counter" data-slug={slug} data-increment={increment}>
  <span class="view-icon">ğŸ‘ï¸</span>
  <span class="view-count">0</span>
</span>

<script>
  function setupViewCounters() {
    const counters = document.querySelectorAll('.view-counter');

    counters.forEach(async (counter) => {
      const slug = counter.getAttribute('data-slug');
      const increment = counter.getAttribute('data-increment') === 'true';
      const countElement = counter.querySelector('.view-count');

      if (!slug || !countElement) return;

      try {
        // LocalStorage ì²´í¬ (24ì‹œê°„ TTL)
        const viewedKey = `viewed:${slug}`;
        const lastViewed = localStorage.getItem(viewedKey);
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000; // 24ì‹œê°„

        let shouldIncrement = increment;

        // 24ì‹œê°„ ì´ë‚´ì— ì¡°íšŒí–ˆë‹¤ë©´ ì¦ê°€í•˜ì§€ ì•ŠìŒ
        if (lastViewed && (now - parseInt(lastViewed)) < oneDay) {
          shouldIncrement = false;
        }

        // ì¦ê°€ ëª¨ë“œì´ê³  LocalStorage ì²´í¬ í†µê³¼í–ˆìœ¼ë©´ POST, ì•„ë‹ˆë©´ GET
        const method = shouldIncrement ? 'POST' : 'GET';
        const response = await fetch(`/api/views/${slug}`, { method });

        if (response.ok) {
          const data = await response.json();
          const views = data.views || 0;
          countElement.textContent = views.toLocaleString();

          // POST ì„±ê³µ ì‹œ LocalStorageì— ê¸°ë¡
          if (method === 'POST' && !data.cached) {
            localStorage.setItem(viewedKey, now.toString());
          }
        } else if (response.status === 429) {
          // Rate Limit ì´ˆê³¼ ì‹œ í˜„ì¬ ì¡°íšŒìˆ˜ë§Œ í‘œì‹œ
          const data = await response.json();
          const views = data.views || 0;
          countElement.textContent = views.toLocaleString();
          console.warn('Rate limit exceeded');
        }
      } catch (error) {
        console.error('Failed to update views:', error);
      }
    });
  }

  // ì´ˆê¸° ë¡œë“œ ì‹œ ì‹¤í–‰
  document.addEventListener('astro:page-load', setupViewCounters);

  // í˜ì´ì§€ ì „í™˜ ì‹œì—ë„ ì‹¤í–‰ (View Transitions ì§€ì›)
  document.addEventListener('astro:after-swap', setupViewCounters);
</script>

<style>
  .view-counter {
    display: inline-flex;
    align-items: center;
    gap: 0.3em;
    font-size: 0.85em;
    color: rgb(var(--gray));
  }

  .view-icon {
    font-size: 1em;
  }

  .view-count {
    font-weight: 600;
  }
</style>
