---
interface QuizItem {
	question: string;
	options: string[];
	correctAnswer: number;
	explanation?: string;
}

interface Props {
	quizzes: QuizItem[];
}

const { quizzes } = Astro.props;

// quizÍ∞Ä ÏóÜÏúºÎ©¥ Î†åÎçîÎßÅÌïòÏßÄ ÏïäÏùå
if (!quizzes || quizzes.length === 0) {
	return null;
}

// ÎûúÎç§ÌïòÍ≤å 5Í∞ú ÏÑ†ÌÉù (Î¨∏Ï†ú ÏùÄÌñâÏóêÏÑú)
function getRandomQuizzes(allQuizzes: QuizItem[], count: number = 5): QuizItem[] {
	const shuffled = [...allQuizzes].sort(() => Math.random() - 0.5);
	return shuffled.slice(0, Math.min(count, allQuizzes.length));
}

const selectedQuizzes = getRandomQuizzes(quizzes, 5);
const totalQuizzes = selectedQuizzes.length;
---

<!-- Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥ -->
<div class="quiz-modal-overlay" id="quiz-modal-overlay" data-all-quizzes={JSON.stringify(quizzes)}>
	<div class="quiz-modal">
		<button class="quiz-modal-close" id="quiz-modal-close" aria-label="ÌÄ¥Ï¶à Îã´Í∏∞">
			<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<line x1="18" y1="6" x2="6" y2="18"></line>
				<line x1="6" y1="6" x2="18" y2="18"></line>
			</svg>
		</button>

		<div class="quiz-container">
	<div class="quiz-header">
		<h2>üìù Î≥µÏäµÌïòÍ∏∞</h2>
		<p>ÌïôÏäµÌïú ÎÇ¥Ïö©ÏùÑ Î≥µÏäµÌï¥Î≥¥ÏÑ∏Ïöî!</p>
	</div>

	{
		selectedQuizzes.map((quiz, quizIndex) => (
			<div class="quiz-item" data-quiz-index={quizIndex}>
				<div class="quiz-question">
					<span class="question-number">Q{quizIndex + 1}.</span>
					<span class="question-text">{quiz.question}</span>
				</div>

				<div class="quiz-options">
					{quiz.options.map((option, optionIndex) => (
						<button
							class="quiz-option"
							data-quiz-index={quizIndex}
							data-option-index={optionIndex}
							data-correct={optionIndex === quiz.correctAnswer}
						>
							<span class="option-label">{String.fromCharCode(65 + optionIndex)}.</span>
							<span class="option-text">{option}</span>
						</button>
					))}
				</div>

				{quiz.explanation && (
					<div class="quiz-explanation" data-quiz-index={quizIndex}>
						<div class="explanation-icon">üí°</div>
						<div class="explanation-text">{quiz.explanation}</div>
					</div>
				)}
			</div>
		))
	}

	<div class="quiz-result">
		<div class="result-score">
			<span class="score-label">Ï†êÏàò:</span>
			<span class="score-value">0 / {quizzes.length}</span>
		</div>
		<button class="reset-btn">Îã§Ïãú ÌíÄÍ∏∞</button>
	</div>
		</div>
	</div>
</div>

<style>
	/* Î™®Îã¨ Ïò§Î≤ÑÎ†àÏù¥ */
	.quiz-modal-overlay {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.7);
		z-index: 9999;
		overflow-y: auto;
		padding: 2em 0;
		animation: fadeIn 0.3s ease;
	}

	.quiz-modal-overlay.active {
		display: flex;
		justify-content: center;
		align-items: flex-start;
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
		}
		to {
			opacity: 1;
		}
	}

	/* Î™®Îã¨ Ïª®ÌÖåÏù¥ÎÑà */
	.quiz-modal {
		position: relative;
		width: 90%;
		max-width: 800px;
		margin: auto;
		animation: slideUp 0.3s ease;
	}

	@keyframes slideUp {
		from {
			transform: translateY(30px);
			opacity: 0;
		}
		to {
			transform: translateY(0);
			opacity: 1;
		}
	}

	/* Îã´Í∏∞ Î≤ÑÌäº */
	.quiz-modal-close {
		position: absolute;
		top: -3em;
		right: 0;
		background: rgba(255, 255, 255, 0.9);
		border: none;
		border-radius: 50%;
		width: 40px;
		height: 40px;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: all 0.3s ease;
		color: rgb(var(--gray-dark));
		z-index: 10000;
	}

	[data-theme="dark"] .quiz-modal-close {
		background: rgba(var(--gray-light), 0.9);
		color: rgb(var(--gray-dark));
	}

	.quiz-modal-close:hover {
		transform: scale(1.1) rotate(90deg);
		background: var(--accent);
		color: white;
	}

	.quiz-modal-close svg {
		width: 20px;
		height: 20px;
	}

	/* ÌÄ¥Ï¶à Ïª®ÌÖåÏù¥ÎÑà */
	.quiz-container {
		margin: 0;
		padding: 2em;
		background: var(--card-bg);
		border: 1px solid rgba(var(--gray-light), 0.5);
		border-radius: 16px;
		box-shadow: 0 4px 12px rgba(var(--gray), 0.1);
	}

	.quiz-header {
		text-align: center;
		margin-bottom: 2em;
		padding-bottom: 1.5em;
		border-bottom: 2px solid rgba(var(--accent-rgb, 91, 109, 255), 0.2);
	}

	.quiz-header h2 {
		margin: 0 0 0.5em 0;
		color: rgb(var(--black));
		font-size: 1.8em;
	}

	.quiz-header p {
		margin: 0;
		color: rgb(var(--gray));
		font-size: 0.95em;
	}

	.quiz-item {
		margin-bottom: 2.5em;
		padding: 1.5em;
		background: rgba(var(--gray-light), 0.1);
		border-radius: 12px;
		transition: all 0.3s ease;
	}

	.quiz-item:last-of-type {
		margin-bottom: 2em;
	}

	.quiz-question {
		display: flex;
		gap: 0.75em;
		margin-bottom: 1.25em;
		font-size: 1.1em;
		font-weight: 600;
		color: rgb(var(--black));
		line-height: 1.5;
	}

	.question-number {
		color: var(--accent);
		flex-shrink: 0;
	}

	.question-text {
		flex: 1;
	}

	.quiz-options {
		display: flex;
		flex-direction: column;
		gap: 0.75em;
	}

	.quiz-option {
		display: flex;
		align-items: center;
		gap: 0.75em;
		padding: 1em 1.25em;
		background: var(--card-bg);
		border: 2px solid rgba(var(--gray-light), 0.5);
		border-radius: 10px;
		cursor: pointer;
		transition: all 0.3s ease;
		text-align: left;
		font-size: 0.95em;
		color: rgb(var(--gray-dark));
	}

	.quiz-option:hover:not(.selected):not(.disabled) {
		border-color: rgba(var(--accent-rgb, 91, 109, 255), 0.4);
		background: rgba(var(--accent-rgb, 91, 109, 255), 0.05);
		transform: translateX(4px);
	}

	.option-label {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 28px;
		height: 28px;
		background: rgba(var(--gray-light), 0.3);
		border-radius: 50%;
		font-weight: 700;
		font-size: 0.85em;
		color: rgb(var(--gray));
		flex-shrink: 0;
	}

	.option-text {
		flex: 1;
		line-height: 1.5;
	}

	/* ÏÑ†ÌÉùÎêú ÏòµÏÖò */
	.quiz-option.selected {
		border-width: 2px;
	}

	.quiz-option.selected.correct {
		border-color: #10b981;
		background: rgba(16, 185, 129, 0.1);
	}

	.quiz-option.selected.correct .option-label {
		background: #10b981;
		color: white;
	}

	.quiz-option.selected.incorrect {
		border-color: #ef4444;
		background: rgba(239, 68, 68, 0.1);
	}

	.quiz-option.selected.incorrect .option-label {
		background: #ef4444;
		color: white;
	}

	/* ÎãµÎ≥Ä ÌõÑ disabled ÏÉÅÌÉú */
	.quiz-option.disabled {
		cursor: not-allowed;
		opacity: 0.6;
	}

	/* Ìï¥ÏÑ§ */
	.quiz-explanation {
		display: none;
		margin-top: 1.25em;
		padding: 1.25em;
		background: rgba(var(--accent-rgb, 91, 109, 255), 0.08);
		border-left: 4px solid var(--accent);
		border-radius: 8px;
		animation: slideDown 0.3s ease;
	}

	.quiz-explanation.show {
		display: flex;
		gap: 1em;
	}

	.explanation-icon {
		font-size: 1.5em;
		flex-shrink: 0;
	}

	.explanation-text {
		flex: 1;
		color: rgb(var(--gray-dark));
		line-height: 1.6;
		font-size: 0.95em;
	}

	@keyframes slideDown {
		from {
			opacity: 0;
			transform: translateY(-10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	/* Í≤∞Í≥º */
	.quiz-result {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 1.5em;
		background: linear-gradient(
			135deg,
			rgba(var(--accent-rgb, 91, 109, 255), 0.1) 0%,
			rgba(var(--accent-rgb, 91, 109, 255), 0.05) 100%
		);
		border-radius: 12px;
		border: 1px solid rgba(var(--accent-rgb, 91, 109, 255), 0.2);
	}

	.result-score {
		display: flex;
		align-items: center;
		gap: 0.75em;
		font-size: 1.1em;
	}

	.score-label {
		color: rgb(var(--gray));
		font-weight: 500;
	}

	.score-value {
		font-weight: 700;
		font-size: 1.3em;
		color: var(--accent);
	}

	.reset-btn {
		padding: 0.75em 1.5em;
		background: var(--accent);
		color: white;
		border: none;
		border-radius: 8px;
		font-weight: 600;
		font-size: 0.95em;
		cursor: pointer;
		transition: all 0.3s ease;
	}

	.reset-btn:hover {
		opacity: 0.9;
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(var(--accent-rgb, 91, 109, 255), 0.3);
	}

	@media (max-width: 640px) {
		.quiz-container {
			padding: 1.5em 1em;
		}

		.quiz-header h2 {
			font-size: 1.5em;
		}

		.quiz-question {
			font-size: 1em;
		}

		.quiz-result {
			flex-direction: column;
			gap: 1em;
			text-align: center;
		}

		.reset-btn {
			width: 100%;
		}
	}
</style>

<script>
	// Î™®Îã¨ Í¥ÄÎ¶¨
	const modalOverlay = document.getElementById('quiz-modal-overlay');
	const modalClose = document.getElementById('quiz-modal-close');

	// Î™®Îã¨ Îã´Í∏∞ Ìï®Ïàò
	function closeModal() {
		modalOverlay?.classList.remove('active');
		document.body.style.overflow = ''; // Ïä§ÌÅ¨Î°§ Î≥µÏõê
	}

	// Îã´Í∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠
	modalClose?.addEventListener('click', closeModal);

	// Ïò§Î≤ÑÎ†àÏù¥ ÌÅ¥Î¶≠ (Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞)
	modalOverlay?.addEventListener('click', (e) => {
		if (e.target === modalOverlay) {
			closeModal();
		}
	});

	// ESC ÌÇ§Î°ú Îã´Í∏∞
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape' && modalOverlay?.classList.contains('active')) {
			closeModal();
		}
	});

	// ÌÄ¥Ï¶à ÏÉÅÌÉú Í¥ÄÎ¶¨
	let answeredQuizzes = new Set<number>();
	let score = 0;
	let totalQuizzes = document.querySelectorAll('.quiz-item').length;

	// Î™®Îì† ÌÄ¥Ï¶à Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
	const allQuizzes = JSON.parse(modalOverlay?.dataset.allQuizzes || '[]');

	// ÏòµÏÖò ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨
	function handleOptionClick(event: Event) {
		const button = event.currentTarget as HTMLButtonElement;
		const quizIndex = parseInt(button.dataset.quizIndex || '0');
		const optionIndex = parseInt(button.dataset.optionIndex || '0');
		const isCorrect = button.dataset.correct === 'true';

		// Ïù¥ÎØ∏ ÎãµÌïú Î¨∏Ï†úÎäî Î¨¥Ïãú
		if (answeredQuizzes.has(quizIndex)) {
			return;
		}

		// ÌòÑÏû¨ ÌÄ¥Ï¶àÏùò Î™®Îì† ÏòµÏÖò Í∞ÄÏ†∏Ïò§Í∏∞
		const quizItem = document.querySelector(`.quiz-item[data-quiz-index="${quizIndex}"]`);
		if (!quizItem) return;

		const allOptions = quizItem.querySelectorAll('.quiz-option');

		// Î™®Îì† ÏòµÏÖò ÎπÑÌôúÏÑ±Ìôî
		allOptions.forEach((opt) => {
			opt.classList.add('disabled');
		});

		// ÏÑ†ÌÉùÌïú ÏòµÏÖò ÌëúÏãú
		button.classList.add('selected');
		button.classList.add(isCorrect ? 'correct' : 'incorrect');

		// Ï†ïÎãµÏù¥ ÏïÑÎãå Í≤ΩÏö∞ Ï†ïÎãµÎèÑ ÌëúÏãú
		if (!isCorrect) {
			const correctButton = quizItem.querySelector('.quiz-option[data-correct="true"]');
			correctButton?.classList.add('selected', 'correct');
		}

		// Ìï¥ÏÑ§ ÌëúÏãú
		const explanation = document.querySelector(`.quiz-explanation[data-quiz-index="${quizIndex}"]`);
		if (explanation) {
			explanation.classList.add('show');
		}

		// Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏
		if (isCorrect) {
			score++;
		}
		answeredQuizzes.add(quizIndex);
		updateScore();
	}

	// Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏
	function updateScore() {
		const scoreValue = document.querySelector('.score-value');
		if (scoreValue) {
			scoreValue.textContent = `${score} / ${totalQuizzes}`;
		}
	}

	// ÎûúÎç§ ÌÄ¥Ï¶à ÏÑ†ÌÉù
	function getRandomQuizzes(allQuizzes: any[], count: number = 5) {
		const shuffled = [...allQuizzes].sort(() => Math.random() - 0.5);
		return shuffled.slice(0, Math.min(count, allQuizzes.length));
	}

	// ÌÄ¥Ï¶à HTML ÏÉùÏÑ±
	function renderQuizzes(quizzes: any[]) {
		const container = document.querySelector('.quiz-container');
		const quizHeader = container?.querySelector('.quiz-header');
		const quizResult = container?.querySelector('.quiz-result');

		if (!container || !quizHeader || !quizResult) return;

		// Í∏∞Ï°¥ ÌÄ¥Ï¶à ÏïÑÏù¥ÌÖú Ï†úÍ±∞
		container.querySelectorAll('.quiz-item').forEach(item => item.remove());

		// ÏÉà ÌÄ¥Ï¶à Î†åÎçîÎßÅ
		quizzes.forEach((quiz, quizIndex) => {
			const quizItem = document.createElement('div');
			quizItem.className = 'quiz-item';
			quizItem.dataset.quizIndex = String(quizIndex);

			const questionDiv = document.createElement('div');
			questionDiv.className = 'quiz-question';
			questionDiv.innerHTML = `
				<span class="question-number">Q${quizIndex + 1}.</span>
				<span class="question-text">${quiz.question}</span>
			`;

			const optionsDiv = document.createElement('div');
			optionsDiv.className = 'quiz-options';

			quiz.options.forEach((option: string, optionIndex: number) => {
				const button = document.createElement('button');
				button.className = 'quiz-option';
				button.dataset.quizIndex = String(quizIndex);
				button.dataset.optionIndex = String(optionIndex);
				button.dataset.correct = String(optionIndex === quiz.correctAnswer);
				button.innerHTML = `
					<span class="option-label">${String.fromCharCode(65 + optionIndex)}.</span>
					<span class="option-text">${option}</span>
				`;
				button.addEventListener('click', handleOptionClick);
				optionsDiv.appendChild(button);
			});

			quizItem.appendChild(questionDiv);
			quizItem.appendChild(optionsDiv);

			if (quiz.explanation) {
				const explanationDiv = document.createElement('div');
				explanationDiv.className = 'quiz-explanation';
				explanationDiv.dataset.quizIndex = String(quizIndex);
				explanationDiv.innerHTML = `
					<div class="explanation-icon">üí°</div>
					<div class="explanation-text">${quiz.explanation}</div>
				`;
				quizItem.appendChild(explanationDiv);
			}

			container.insertBefore(quizItem, quizResult);
		});

		// totalQuizzes ÏóÖÎç∞Ïù¥Ìä∏
		totalQuizzes = quizzes.length;
	}

	// Îã§Ïãú ÌíÄÍ∏∞
	function resetQuiz() {
		// ÏÉàÎ°úÏö¥ ÎûúÎç§ ÌÄ¥Ï¶à ÏÑ†ÌÉù Î∞è Î†åÎçîÎßÅ
		const newQuizzes = getRandomQuizzes(allQuizzes, 5);
		renderQuizzes(newQuizzes);

		// ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
		answeredQuizzes.clear();
		score = 0;
		updateScore();

		// Ï≤´ Î≤àÏß∏ ÌÄ¥Ï¶àÎ°ú Ïä§ÌÅ¨Î°§
		const firstQuiz = document.querySelector('.quiz-item');
		if (firstQuiz) {
			firstQuiz.scrollIntoView({ behavior: 'smooth', block: 'center' });
		}
	}

	// Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
	document.addEventListener('astro:page-load', () => {
		// ÏòµÏÖò ÌÅ¥Î¶≠
		document.querySelectorAll('.quiz-option').forEach((button) => {
			button.addEventListener('click', handleOptionClick);
		});

		// Îã§Ïãú ÌíÄÍ∏∞ Î≤ÑÌäº
		const resetBtn = document.querySelector('.reset-btn');
		resetBtn?.addEventListener('click', resetQuiz);
	});
</script>
