---
import { getCollection } from 'astro:content';
import { ViewTransitions } from 'astro:transitions';
import Analytics from '@vercel/analytics/astro';
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import StructuredData from '../../components/StructuredData.astro';
import WikiGraph from '../../components/WikiGraph.astro';
import { SITE_TITLE } from '../../consts';

import fs from 'node:fs';
import path from 'node:path';

const allWiki = await getCollection('wiki');

// Manually read frontmatter for related field
const wikiDir = 'src/content/wiki';
const wikiWithRelated = allWiki.map(wiki => {
	try {
		const filePath = path.join(process.cwd(), wikiDir, `${wiki.id}.md`);
		const content = fs.readFileSync(filePath, 'utf-8');
		const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
		if (frontmatterMatch) {
			const relatedMatch = frontmatterMatch[1].match(/related:\s*\[(.*?)\]/);
			if (relatedMatch) {
				const related = relatedMatch[1].split(',').map(s => s.trim().replace(/['"]/g, '')).filter(Boolean);
				return { ...wiki, data: { ...wiki.data, related } };
			}
		}
	} catch (e) {}
	return { ...wiki, data: { ...wiki.data, related: [] } };
});

const categories = {
	database: { name: 'Database', icon: 'ğŸ—„ï¸', items: [] as typeof allWiki },
	java: { name: 'Java', icon: 'â˜•', items: [] as typeof allWiki },
	spring: { name: 'Spring', icon: 'ğŸŒ±', items: [] as typeof allWiki },
	architecture: { name: 'Architecture', icon: 'ğŸ—ï¸', items: [] as typeof allWiki },
	infra: { name: 'Infra', icon: 'ğŸ³', items: [] as typeof allWiki },
	general: { name: 'General', icon: 'ğŸ“š', items: [] as typeof allWiki },
};

allWiki.forEach(wiki => {
	categories[wiki.data.category].items.push(wiki);
});

Object.values(categories).forEach(cat => {
	cat.items.sort((a, b) => a.data.term.localeCompare(b.data.term, 'ko'));
});

// ê·¸ë˜í”„ ë°ì´í„° ìƒì„± (wikiWithRelated ì‚¬ìš©)
const graphNodes = wikiWithRelated.map(wiki => ({
	id: wiki.id,
	term: wiki.data.term,
	category: wiki.data.category,
	summary: wiki.data.summary,
}));

const graphLinks: { source: string; target: string }[] = [];
wikiWithRelated.forEach(wiki => {
	if (wiki.data.related && wiki.data.related.length > 0) {
		wiki.data.related.forEach((relatedId: string) => {
			// ì¤‘ë³µ ë§í¬ ë°©ì§€
			const exists = graphLinks.some(
				link => (link.source === wiki.id && link.target === relatedId) ||
				        (link.source === relatedId && link.target === wiki.id)
			);
			if (!exists && wikiWithRelated.some(w => w.id === relatedId)) {
				graphLinks.push({ source: wiki.id, target: relatedId });
			}
		});
	}
});
---

<html lang="ko" data-theme="dark">
	<head>
		<ViewTransitions />
		<BaseHead title={`Wiki - ${SITE_TITLE}`} description="ê°œë°œ ìš©ì–´ ì‚¬ì „" />
		<StructuredData
			type="website"
			title={`Wiki - ${SITE_TITLE}`}
			description="ê°œë°œ ìš©ì–´ ì‚¬ì „"
			url={Astro.url}
		/>
		<style>
			main {
				width: 960px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 2em 1em;
			}
			.wiki-header {
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
				margin-bottom: 1.5em;
				flex-wrap: wrap;
				gap: 1em;
			}
			h1 {
				margin-bottom: 0.25em;
			}
			.description {
				color: rgb(var(--gray));
				margin: 0;
			}
			.view-toggle {
				display: flex;
				gap: 4px;
				background: rgb(var(--gray-light), 0.3);
				padding: 4px;
				border-radius: 8px;
			}
			.view-btn {
				display: flex;
				align-items: center;
				justify-content: center;
				width: 36px;
				height: 36px;
				border: none;
				background: transparent;
				border-radius: 6px;
				cursor: pointer;
				color: rgb(var(--gray));
				transition: all 0.2s;
			}
			.view-btn:hover {
				background: rgb(var(--gray-light), 0.5);
			}
			.view-btn.active {
				background: var(--card-bg);
				color: var(--accent);
				box-shadow: 0 1px 3px rgba(0,0,0,0.1);
			}
			.view-content.hidden {
				display: none;
			}
			.graph-hint {
				text-align: center;
				color: rgb(var(--gray));
				font-size: 0.9em;
				margin-top: 0.5em;
			}
			.search-box {
				width: 100%;
				padding: 0.75em 1em;
				font-size: 1em;
				border: 1px solid rgb(var(--gray-light));
				border-radius: 8px;
				margin-bottom: 2em;
				background: var(--card-bg);
				color: rgb(var(--gray-dark));
			}
			.search-box:focus {
				outline: none;
				border-color: var(--accent);
			}
			.category {
				margin-bottom: 2em;
			}
			.category h2 {
				font-size: 1.2em;
				margin-bottom: 0.75em;
				padding-bottom: 0.5em;
				border-bottom: 2px solid rgb(var(--gray-light));
			}
			.wiki-list {
				list-style: none;
				padding: 0;
				margin: 0;
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
				gap: 1em;
			}
			.wiki-item {
				background: var(--card-bg);
				border: 1px solid rgb(var(--gray-light));
				border-radius: 8px;
				padding: 1em;
				transition: border-color 0.2s ease, box-shadow 0.2s ease;
			}
			.wiki-item:hover {
				border-color: var(--accent);
				box-shadow: 0 2px 8px rgba(var(--gray), 0.1);
			}
			.wiki-item a {
				text-decoration: none;
				color: inherit;
				display: block;
			}
			.wiki-term {
				font-weight: 600;
				color: rgb(var(--black));
				margin-bottom: 0.5em;
			}
			.wiki-summary {
				font-size: 0.9em;
				color: rgb(var(--gray));
				line-height: 1.5;
			}
			.wiki-aliases {
				font-size: 0.8em;
				color: rgb(var(--gray-light));
				margin-top: 0.5em;
			}
			.hidden {
				display: none;
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<div class="wiki-header">
				<div>
					<h1>Wiki</h1>
					<p class="description">ê°œë°œ ìš©ì–´ ì‚¬ì „ì…ë‹ˆë‹¤. ë¸”ë¡œê·¸ ê¸€ì—ì„œ ìš©ì–´ë¥¼ í´ë¦­í•˜ë©´ ì´ê³³ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.</p>
				</div>
				<div class="view-toggle">
					<button id="list-view-btn" class="view-btn active" title="ëª©ë¡ ë³´ê¸°">
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<line x1="8" y1="6" x2="21" y2="6"></line>
							<line x1="8" y1="12" x2="21" y2="12"></line>
							<line x1="8" y1="18" x2="21" y2="18"></line>
							<line x1="3" y1="6" x2="3.01" y2="6"></line>
							<line x1="3" y1="12" x2="3.01" y2="12"></line>
							<line x1="3" y1="18" x2="3.01" y2="18"></line>
						</svg>
					</button>
					<button id="graph-view-btn" class="view-btn" title="ê·¸ë˜í”„ ë³´ê¸°">
						<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<circle cx="12" cy="12" r="3"></circle>
							<circle cx="19" cy="5" r="2"></circle>
							<circle cx="5" cy="19" r="2"></circle>
							<circle cx="5" cy="5" r="2"></circle>
							<circle cx="19" cy="19" r="2"></circle>
							<line x1="14.5" y1="10" x2="17.5" y2="6.5"></line>
							<line x1="9.5" y1="14" x2="6.5" y2="17.5"></line>
							<line x1="9.5" y1="10" x2="6.5" y2="6.5"></line>
							<line x1="14.5" y1="14" x2="17.5" y2="17.5"></line>
						</svg>
					</button>
				</div>
			</div>

			<div id="graph-view" class="view-content hidden">
				<WikiGraph nodes={graphNodes} links={graphLinks} />
				<p class="graph-hint">ë…¸ë“œë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—°ê²°ëœ ê°œë…ì„ í™•ì¸í•˜ì„¸ìš”!</p>
							</div>

			<div id="list-view" class="view-content">
				<input
					type="text"
					class="search-box"
					placeholder="ìš©ì–´ ê²€ìƒ‰..."
					id="wiki-search"
				/>

			{Object.entries(categories).map(([key, category]) => (
				category.items.length > 0 && (
					<section class="category" data-category={key}>
						<h2>{category.icon} {category.name}</h2>
						<ul class="wiki-list">
							{category.items.map(wiki => (
								<li class="wiki-item" data-term={wiki.data.term.toLowerCase()} data-aliases={wiki.data.aliases?.join(',').toLowerCase() || ''}>
									<a href={`/wiki/${wiki.id}`}>
										<div class="wiki-term">{wiki.data.term}</div>
										<div class="wiki-summary">{wiki.data.summary}</div>
										{wiki.data.aliases && wiki.data.aliases.length > 0 && (
											<div class="wiki-aliases">
												{wiki.data.aliases.join(', ')}
											</div>
										)}
									</a>
								</li>
							))}
						</ul>
					</section>
				)
			))}
			</div>
		</main>
		<Footer />

		<script>
			// ë·° í† ê¸€
			const listViewBtn = document.getElementById('list-view-btn');
			const graphViewBtn = document.getElementById('graph-view-btn');
			const listView = document.getElementById('list-view');
			const graphView = document.getElementById('graph-view');

			function setView(view: 'list' | 'graph') {
				if (view === 'list') {
					listView?.classList.remove('hidden');
					graphView?.classList.add('hidden');
					listViewBtn?.classList.add('active');
					graphViewBtn?.classList.remove('active');
				} else {
					listView?.classList.add('hidden');
					graphView?.classList.remove('hidden');
					listViewBtn?.classList.remove('active');
					graphViewBtn?.classList.add('active');
				}
				localStorage.setItem('wiki-view', view);
			}

			listViewBtn?.addEventListener('click', () => setView('list'));
			graphViewBtn?.addEventListener('click', () => setView('graph'));

			// ì €ì¥ëœ ë·° ë³µì›
			const savedView = localStorage.getItem('wiki-view') as 'list' | 'graph' | null;
			if (savedView) {
				setView(savedView);
			}

			// ê²€ìƒ‰
			const searchInput = document.getElementById('wiki-search') as HTMLInputElement;
			const wikiItems = document.querySelectorAll('.wiki-item');

			searchInput?.addEventListener('input', (e) => {
				const query = (e.target as HTMLInputElement).value.toLowerCase();

				wikiItems.forEach(item => {
					const term = item.getAttribute('data-term') || '';
					const aliases = item.getAttribute('data-aliases') || '';

					if (term.includes(query) || aliases.includes(query)) {
						item.classList.remove('hidden');
					} else {
						item.classList.add('hidden');
					}
				});
			});
		</script>
		<Analytics />
	</body>
</html>
