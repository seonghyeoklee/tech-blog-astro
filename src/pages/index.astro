---
import { getCollection } from 'astro:content';
import { ViewTransitions } from 'astro:transitions';
import Analytics from '@vercel/analytics/astro';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import WikiGraph from '../components/WikiGraph.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import fs from 'node:fs';
import path from 'node:path';

const wikiTerms = await getCollection('wiki');

// 위키 그래프 데이터 생성
const wikiDir = 'src/content/wiki';
const wikiWithRelated = wikiTerms.map(wiki => {
	try {
		const filePath = path.join(process.cwd(), wikiDir, `${wiki.id}.md`);
		const content = fs.readFileSync(filePath, 'utf-8');
		const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
		if (frontmatterMatch) {
			const relatedMatch = frontmatterMatch[1].match(/related:\s*\[(.*?)\]/);
			if (relatedMatch) {
				const related = relatedMatch[1].split(',').map(s => s.trim().replace(/['"]/g, '')).filter(Boolean);
				return { ...wiki, data: { ...wiki.data, related } };
			}
		}
	} catch (e) {}
	return { ...wiki, data: { ...wiki.data, related: [] } };
});

const graphNodes = wikiWithRelated.map(wiki => ({
	id: wiki.id,
	term: wiki.data.term,
	category: wiki.data.category,
	summary: wiki.data.summary,
}));

const graphLinks: { source: string; target: string }[] = [];
wikiWithRelated.forEach(wiki => {
	if (wiki.data.related && wiki.data.related.length > 0) {
		wiki.data.related.forEach((relatedId: string) => {
			const exists = graphLinks.some(
				link => (link.source === wiki.id && link.target === relatedId) ||
				        (link.source === relatedId && link.target === wiki.id)
			);
			if (!exists && wikiWithRelated.some(w => w.id === relatedId)) {
				graphLinks.push({ source: wiki.id, target: relatedId });
			}
		});
	}
});
---

<!doctype html>
<html lang="ko" data-theme="dark">
	<head>
		<ViewTransitions />
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			html, body {
				overflow: hidden;
				height: 100vh;
			}
			body {
				display: flex;
				flex-direction: column;
			}
			.universe-container {
				flex: 1;
				position: relative;
				background: radial-gradient(ellipse at center, #0d0d1a 0%, #000008 100%);
				overflow: hidden;
			}
			/* 별 배경 */
			.stars {
				position: absolute;
				inset: 0;
				z-index: 0;
			}
			.star {
				position: absolute;
				background: #fff;
				border-radius: 50%;
				animation: twinkle var(--duration, 3s) ease-in-out infinite;
				animation-delay: var(--delay, 0s);
			}
			@keyframes twinkle {
				0%, 100% { opacity: var(--min-opacity, 0.3); transform: scale(1); }
				50% { opacity: 1; transform: scale(1.2); }
			}
			/* 은하수 효과 */
			.milky-way {
				position: absolute;
				top: 50%;
				left: 50%;
				width: 200%;
				height: 60%;
				transform: translate(-50%, -50%) rotate(-15deg);
				background: radial-gradient(ellipse, rgba(100, 100, 180, 0.08) 0%, transparent 60%);
				pointer-events: none;
				z-index: 0;
			}
			/* 성운 효과 - 더 역동적 */
			.nebula {
				position: absolute;
				border-radius: 50%;
				filter: blur(100px);
				opacity: 0.2;
				z-index: 0;
			}
			.nebula-1 {
				width: 600px;
				height: 600px;
				background: radial-gradient(circle, rgba(138, 43, 226, 0.5) 0%, transparent 70%);
				top: 5%;
				left: 5%;
				animation: nebula-drift-1 30s ease-in-out infinite;
			}
			.nebula-2 {
				width: 500px;
				height: 500px;
				background: radial-gradient(circle, rgba(30, 144, 255, 0.4) 0%, transparent 70%);
				bottom: 10%;
				right: 10%;
				animation: nebula-drift-2 25s ease-in-out infinite;
			}
			.nebula-3 {
				width: 400px;
				height: 400px;
				background: radial-gradient(circle, rgba(255, 105, 180, 0.35) 0%, transparent 70%);
				top: 50%;
				left: 50%;
				animation: nebula-drift-3 35s ease-in-out infinite;
			}
			.nebula-4 {
				width: 350px;
				height: 350px;
				background: radial-gradient(circle, rgba(0, 255, 200, 0.25) 0%, transparent 70%);
				top: 20%;
				right: 30%;
				animation: nebula-drift-4 28s ease-in-out infinite;
			}
			@keyframes nebula-drift-1 {
				0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.2; }
				25% { transform: translate(50px, 30px) scale(1.1); opacity: 0.25; }
				50% { transform: translate(20px, 60px) scale(0.95); opacity: 0.18; }
				75% { transform: translate(-30px, 20px) scale(1.05); opacity: 0.22; }
			}
			@keyframes nebula-drift-2 {
				0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.2; }
				33% { transform: translate(-40px, -20px) scale(1.08); opacity: 0.25; }
				66% { transform: translate(30px, -40px) scale(0.92); opacity: 0.15; }
			}
			@keyframes nebula-drift-3 {
				0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.2; }
				50% { transform: translate(-45%, -55%) scale(1.15); opacity: 0.28; }
			}
			@keyframes nebula-drift-4 {
				0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.18; }
				40% { transform: translate(-20px, 40px) scale(1.1); opacity: 0.25; }
				80% { transform: translate(40px, -20px) scale(0.9); opacity: 0.15; }
			}
			/* 유성 효과 */
			.shooting-stars {
				position: absolute;
				inset: 0;
				z-index: 1;
				pointer-events: none;
				overflow: hidden;
			}
			.shooting-star {
				position: absolute;
				width: 100px;
				height: 1px;
				background: linear-gradient(90deg, rgba(255,255,255,0.8), transparent);
				transform: rotate(-45deg);
				animation: shoot linear infinite;
				opacity: 0;
			}
			@keyframes shoot {
				0% { transform: translateX(-100px) translateY(-100px) rotate(-45deg); opacity: 0; }
				5% { opacity: 1; }
				20% { opacity: 1; }
				100% { transform: translateX(calc(100vw + 200px)) translateY(calc(100vh + 200px)) rotate(-45deg); opacity: 0; }
			}
			/* 오로라 효과 */
			.aurora {
				position: absolute;
				bottom: 0;
				left: 0;
				right: 0;
				height: 40%;
				background: linear-gradient(180deg,
					transparent 0%,
					rgba(0, 255, 150, 0.03) 30%,
					rgba(100, 200, 255, 0.05) 60%,
					rgba(150, 100, 255, 0.03) 100%
				);
				filter: blur(40px);
				animation: aurora-wave 15s ease-in-out infinite;
				z-index: 0;
				pointer-events: none;
			}
			@keyframes aurora-wave {
				0%, 100% { transform: translateY(0) scaleY(1); opacity: 0.5; }
				50% { transform: translateY(-20px) scaleY(1.1); opacity: 0.7; }
			}
		</style>
	</head>
	<body>
		<Header />
		<div class="universe-container">
			<div class="stars" id="stars"></div>
			<div class="shooting-stars" id="shooting-stars"></div>
			<div class="milky-way"></div>
			<div class="aurora"></div>
			<div class="nebula nebula-1"></div>
			<div class="nebula nebula-2"></div>
			<div class="nebula nebula-3"></div>
			<div class="nebula nebula-4"></div>
			<WikiGraph nodes={graphNodes} links={graphLinks} fullscreen={true} />
		</div>
		<Analytics />
		<script>
			// 별 생성
			function createStars() {
				const container = document.getElementById('stars');
				if (!container) return;
				container.innerHTML = '';
				const count = 200;
				for (let i = 0; i < count; i++) {
					const star = document.createElement('div');
					star.className = 'star';
					const size = Math.random() * 2.5 + 0.5;
					star.style.width = size + 'px';
					star.style.height = size + 'px';
					star.style.left = Math.random() * 100 + '%';
					star.style.top = Math.random() * 100 + '%';
					star.style.setProperty('--duration', (2 + Math.random() * 4) + 's');
					star.style.setProperty('--delay', Math.random() * 5 + 's');
					star.style.setProperty('--min-opacity', (0.2 + Math.random() * 0.4).toString());
					container.appendChild(star);
				}
			}

			// 유성 생성
			function createShootingStars() {
				const container = document.getElementById('shooting-stars');
				if (!container) return;
				container.innerHTML = '';

				// 3개의 유성을 다른 타이밍으로
				for (let i = 0; i < 3; i++) {
					const star = document.createElement('div');
					star.className = 'shooting-star';
					star.style.left = (Math.random() * 70) + '%';
					star.style.top = (Math.random() * 50) + '%';
					star.style.animationDuration = (3 + Math.random() * 2) + 's';
					star.style.animationDelay = (i * 8 + Math.random() * 5) + 's';
					container.appendChild(star);
				}
			}

			function initUniverse() {
				createStars();
				createShootingStars();
			}

			initUniverse();
			document.addEventListener('astro:page-load', initUniverse);
		</script>
	</body>
</html>
