---
import { getCollection } from 'astro:content';
import { ViewTransitions } from 'astro:transitions';
import Analytics from '@vercel/analytics/astro';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import StructuredData from '../components/StructuredData.astro';
import WikiGraph from '../components/WikiGraph.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import fs from 'node:fs';
import path from 'node:path';

const wikiTerms = await getCollection('wiki');

// ìœ„í‚¤ ê·¸ë˜í”„ ë°ì´í„° ìƒì„±
const wikiDir = 'src/content/wiki';
const wikiWithRelated = wikiTerms.map(wiki => {
	try {
		const filePath = path.join(process.cwd(), wikiDir, `${wiki.id}.md`);
		const content = fs.readFileSync(filePath, 'utf-8');
		const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
		if (frontmatterMatch) {
			const relatedMatch = frontmatterMatch[1].match(/related:\s*\[(.*?)\]/);
			if (relatedMatch) {
				const related = relatedMatch[1].split(',').map(s => s.trim().replace(/['"]/g, '')).filter(Boolean);
				return { ...wiki, data: { ...wiki.data, related } };
			}
		}
	} catch (e) {}
	return { ...wiki, data: { ...wiki.data, related: [] } };
});

const graphNodes = wikiWithRelated.map(wiki => ({
	id: wiki.id,
	term: wiki.data.term,
	category: wiki.data.category,
	summary: wiki.data.summary,
}));

const graphLinks: { source: string; target: string }[] = [];
wikiWithRelated.forEach(wiki => {
	if (wiki.data.related && wiki.data.related.length > 0) {
		wiki.data.related.forEach((relatedId: string) => {
			const exists = graphLinks.some(
				link => (link.source === wiki.id && link.target === relatedId) ||
				        (link.source === relatedId && link.target === wiki.id)
			);
			if (!exists && wikiWithRelated.some(w => w.id === relatedId)) {
				graphLinks.push({ source: wiki.id, target: relatedId });
			}
		});
	}
});

const docs = [
	{ name: 'Java', url: 'https://docs.oracle.com/en/java/', icon: 'java/java-original' },
	{ name: 'Spring', url: 'https://docs.spring.io/spring-framework/reference/', icon: 'spring/spring-original' },
	{ name: 'Spring Boot', url: 'https://docs.spring.io/spring-boot/docs/current/reference/html/', icon: 'spring/spring-original' },
	{ name: 'JPA/Hibernate', url: 'https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html', icon: 'hibernate/hibernate-original' },
	{ name: 'MySQL', url: 'https://dev.mysql.com/doc/refman/8.0/en/', icon: 'mysql/mysql-original' },
	{ name: 'Redis', url: 'https://redis.io/docs/', icon: 'redis/redis-original' },
	{ name: 'Kafka', url: 'https://kafka.apache.org/documentation/', icon: 'apachekafka/apachekafka-original' },
	{ name: 'Docker', url: 'https://docs.docker.com/', icon: 'docker/docker-original' },
	{ name: 'Kubernetes', url: 'https://kubernetes.io/docs/home/', icon: 'kubernetes/kubernetes-original' },
	{ name: 'AWS', url: 'https://docs.aws.amazon.com/', icon: 'amazonwebservices/amazonwebservices-plain-wordmark' },
	{ name: 'JUnit 5', url: 'https://junit.org/junit5/docs/current/user-guide/', icon: 'junit/junit-original' },
	{ name: 'Gradle', url: 'https://docs.gradle.org/current/userguide/userguide.html', icon: 'gradle/gradle-original' },
];

const resources = [
	{ name: 'Baeldung', url: 'https://www.baeldung.com/', desc: 'Java/Spring íŠœí† ë¦¬ì–¼' },
	{ name: 'Martin Fowler', url: 'https://martinfowler.com/', desc: 'ì•„í‚¤í…ì²˜/ì„¤ê³„ íŒ¨í„´' },
	{ name: 'Refactoring Guru', url: 'https://refactoring.guru/', desc: 'ë””ìì¸ íŒ¨í„´/ë¦¬íŒ©í† ë§' },
	{ name: 'Java Design Patterns', url: 'https://java-design-patterns.com/', desc: 'Java ë””ìì¸ íŒ¨í„´ ì˜ˆì œ' },
	{ name: 'Spring Guides', url: 'https://spring.io/guides', desc: 'Spring ê³µì‹ ê°€ì´ë“œ' },
	{ name: 'DZone', url: 'https://dzone.com/java', desc: 'Java ê°œë°œì ì»¤ë®¤ë‹ˆí‹°' },
	{ name: 'InfoQ', url: 'https://www.infoq.com/', desc: 'ì†Œí”„íŠ¸ì›¨ì–´ ê°œë°œ íŠ¸ë Œë“œ' },
	{ name: 'High Scalability', url: 'http://highscalability.com/', desc: 'ëŒ€ê·œëª¨ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜' },
];
---

<!doctype html>
<html lang="ko" data-theme="dark">
	<head>
		<ViewTransitions />
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<StructuredData
			type="website"
			title={SITE_TITLE}
			description={SITE_DESCRIPTION}
			url={Astro.url}
		/>
		<style>
			/* Wiki Graph Section */
			.wiki-graph-section {
				width: 100%;
				max-width: 100%;
				margin: 0;
				padding: 3em 2em;
				background: linear-gradient(180deg, #0a0a12 0%, #12121f 50%, #0f0f1a 100%);
				position: relative;
				overflow: hidden;
			}
			.wiki-graph-section::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				height: 1px;
				background: linear-gradient(90deg, transparent, rgba(168, 139, 250, 0.3), transparent);
			}
			.wiki-graph-section::after {
				content: '';
				position: absolute;
				bottom: 0;
				left: 0;
				right: 0;
				height: 1px;
				background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.3), transparent);
			}
			.wiki-graph-header {
				text-align: center;
				margin-bottom: 1.5em;
				position: relative;
				z-index: 1;
			}
			.wiki-graph-header h2 {
				font-size: 2.5em;
				font-weight: 800;
				margin-bottom: 0.4em;
				background: linear-gradient(135deg, #fff 0%, #a78bfa 50%, #60a5fa 100%);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
				text-shadow: none;
			}
			.wiki-graph-header p {
				font-size: 1.05em;
				color: rgba(255, 255, 255, 0.6);
				margin-bottom: 1em;
			}
			.wiki-link {
				display: inline-flex;
				align-items: center;
				gap: 0.4em;
				color: #a78bfa;
				text-decoration: none;
				font-size: 0.95em;
				font-weight: 600;
				padding: 0.5em 1.2em;
				background: rgba(167, 139, 250, 0.1);
				border: 1px solid rgba(167, 139, 250, 0.2);
				border-radius: 20px;
				transition: all 0.3s ease;
			}
			.wiki-link:hover {
				gap: 0.6em;
				background: rgba(167, 139, 250, 0.2);
				border-color: rgba(167, 139, 250, 0.4);
				box-shadow: 0 0 20px rgba(167, 139, 250, 0.3);
			}

			main {
				width: 960px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 3em 1em 4em;
			}

			/* Section Headers */
			.section-header {
				margin-bottom: 2.5em;
			}
			.section-title {
				font-size: 2em;
				font-weight: 700;
				margin-bottom: 0.5em;
				color: rgb(var(--black));
			}
			.section-subtitle {
				font-size: 1.05em;
				color: rgb(var(--gray));
			}

			/* Grid Layout */
			.grid {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 2em;
				margin-bottom: 2em;
			}
			@media (max-width: 768px) {
				.grid {
					grid-template-columns: 1fr;
				}
			}

			/* Section Cards */
			section {
				background: var(--card-bg);
				border: 1px solid rgba(var(--gray-light), 0.5);
				border-radius: 20px;
				padding: 2em;
				transition: all 0.3s ease;
				position: relative;
			}
			section::after {
				content: '';
				position: absolute;
				inset: 0;
				border-radius: 20px;
				padding: 1px;
				background: linear-gradient(135deg, rgba(var(--accent-rgb, 91, 109, 255), 0.1) 0%, transparent 100%);
				-webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
				-webkit-mask-composite: xor;
				mask-composite: exclude;
				pointer-events: none;
				opacity: 0;
				transition: opacity 0.3s ease;
			}
			section:hover::after {
				opacity: 1;
			}
			section:hover {
				transform: translateY(-2px);
				box-shadow: 0 8px 32px rgba(var(--gray), 0.12);
				border-color: rgba(var(--accent-rgb, 91, 109, 255), 0.2);
			}
			section h2 {
				font-size: 1.1em;
				font-weight: 700;
				margin: 0 0 1.5em;
				color: rgb(var(--black));
				display: flex;
				align-items: center;
				gap: 0.5em;
			}

			/* Docs Grid */
			.docs-grid {
				display: grid;
				grid-template-columns: repeat(6, 1fr);
				gap: 1.2em;
			}
			@media (max-width: 768px) {
				.docs-grid {
					grid-template-columns: repeat(3, 1fr);
					gap: 1em;
				}
			}
			.doc-link {
				display: flex;
				flex-direction: column;
				align-items: center;
				padding: 1.5em 1em;
				background: linear-gradient(135deg, rgba(var(--gray-light), 0.15) 0%, rgba(var(--gray-light), 0.05) 100%);
				border: 1px solid rgba(var(--gray-light), 0.3);
				border-radius: 16px;
				text-decoration: none;
				color: rgb(var(--gray-dark));
				font-size: 0.85em;
				font-weight: 600;
				transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
				position: relative;
				overflow: hidden;
			}
			.doc-link::before {
				content: '';
				position: absolute;
				inset: 0;
				background: linear-gradient(135deg, rgba(var(--accent-rgb, 91, 109, 255), 0.08) 0%, transparent 100%);
				opacity: 0;
				transition: opacity 0.3s ease;
			}
			.doc-link:hover::before {
				opacity: 1;
			}
			.doc-link:hover {
				border-color: rgba(var(--accent-rgb, 91, 109, 255), 0.4);
				transform: translateY(-6px);
				box-shadow: 0 8px 24px rgba(var(--gray), 0.15);
			}
			.doc-link:hover .doc-icon {
				transform: scale(1.15) rotate(5deg);
			}
			.doc-icon {
				width: 40px;
				height: 40px;
				margin-bottom: 0.8em;
				transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
				position: relative;
				z-index: 1;
			}

			/* Resources */
			.resources-grid {
				display: grid;
				grid-template-columns: repeat(4, 1fr);
				gap: 1.2em;
			}
			@media (max-width: 960px) {
				.resources-grid {
					grid-template-columns: repeat(2, 1fr);
				}
			}
			@media (max-width: 520px) {
				.resources-grid {
					grid-template-columns: 1fr;
				}
			}
			.resource-card {
				display: block;
				padding: 1.5em 1.5em;
				background: linear-gradient(135deg, rgba(var(--gray-light), 0.15) 0%, rgba(var(--gray-light), 0.05) 100%);
				border: 1px solid rgba(var(--gray-light), 0.3);
				border-radius: 16px;
				text-decoration: none;
				transition: all 0.3s ease;
				position: relative;
			}
			.resource-card::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				width: 3px;
				height: 0;
				background: linear-gradient(180deg, var(--accent) 0%, rgba(var(--accent-rgb, 91, 109, 255), 0.3) 100%);
				border-radius: 0 2px 2px 0;
				transition: height 0.3s ease;
			}
			.resource-card:hover::before {
				height: 100%;
			}
			.resource-card:hover {
				background: rgba(var(--gray-light), 0.25);
				border-color: rgba(var(--accent-rgb, 91, 109, 255), 0.2);
				transform: translateX(6px);
				box-shadow: 0 4px 16px rgba(var(--gray), 0.1);
			}
			.resource-name {
				color: rgb(var(--black));
				font-weight: 700;
				font-size: 1.05em;
				margin-bottom: 0.4em;
			}
			.resource-desc {
				font-size: 0.85em;
				color: rgb(var(--gray));
				line-height: 1.5;
			}

			.full-width {
				grid-column: 1 / -1;
			}

			/* Responsive Design */
			@media (max-width: 768px) {
				.wiki-graph-section {
					padding: 2em 1em;
				}
				.wiki-graph-header h2 {
					font-size: 1.8em;
				}
				.wiki-graph-header p {
					font-size: 0.95em;
				}
				.section-title {
					font-size: 1.6em;
				}
			}
		</style>
	</head>
	<body>
		<Header />

		<!-- Wiki Knowledge Graph -->
		<div class="wiki-graph-section">
			<div class="wiki-graph-header">
				<h2>Knowledge Graph</h2>
				<p>ê°œë…ë“¤ì´ ì–´ë–»ê²Œ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. ë…¸ë“œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ìœ„í‚¤ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
				<a href="/wiki" class="wiki-link">Wiki ì „ì²´ë³´ê¸° â†’</a>
			</div>
			<WikiGraph nodes={graphNodes} links={graphLinks} />
		</div>

		<main>
			<div class="grid">
				<section class="full-width">
					<h2>ğŸ“š ê³µì‹ ë¬¸ì„œ</h2>
					<div class="docs-grid">
						{docs.map((doc) => (
							<a href={doc.url} target="_blank" rel="noopener" class="doc-link">
								<img src={`https://cdn.jsdelivr.net/gh/devicons/devicon/icons/${doc.icon}.svg`} alt={doc.name} class="doc-icon" />
								<span>{doc.name}</span>
							</a>
						))}
					</div>
				</section>

				<section class="full-width">
					<h2>ğŸ”— ì¶”ì²œ ë¦¬ì†ŒìŠ¤</h2>
					<div class="resources-grid">
						{resources.map((res) => (
							<a href={res.url} target="_blank" rel="noopener" class="resource-card">
								<div class="resource-name">{res.name}</div>
								<div class="resource-desc">{res.desc}</div>
							</a>
						))}
					</div>
				</section>
			</div>
		</main>
		<Footer />
		<Analytics />
	</body>
</html>
