---
import { getCollection } from 'astro:content';
import { ViewTransitions } from 'astro:transitions';
import Analytics from '@vercel/analytics/astro';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import WikiGraph from '../components/WikiGraph.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import fs from 'node:fs';
import path from 'node:path';

const wikiTerms = await getCollection('wiki');

// 위키 그래프 데이터 생성
const wikiDir = 'src/content/wiki';
const wikiWithRelated = wikiTerms.map(wiki => {
	try {
		const filePath = path.join(process.cwd(), wikiDir, `${wiki.id}.md`);
		const content = fs.readFileSync(filePath, 'utf-8');
		const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
		if (frontmatterMatch) {
			const relatedMatch = frontmatterMatch[1].match(/related:\s*\[(.*?)\]/);
			if (relatedMatch) {
				const related = relatedMatch[1].split(',').map(s => s.trim().replace(/['"]/g, '')).filter(Boolean);
				return { ...wiki, data: { ...wiki.data, related } };
			}
		}
	} catch (e) {}
	return { ...wiki, data: { ...wiki.data, related: [] } };
});

const graphNodes = wikiWithRelated.map(wiki => ({
	id: wiki.id,
	term: wiki.data.term,
	category: wiki.data.category,
	summary: wiki.data.summary,
}));

const graphLinks: { source: string; target: string }[] = [];
wikiWithRelated.forEach(wiki => {
	if (wiki.data.related && wiki.data.related.length > 0) {
		wiki.data.related.forEach((relatedId: string) => {
			const exists = graphLinks.some(
				link => (link.source === wiki.id && link.target === relatedId) ||
				        (link.source === relatedId && link.target === wiki.id)
			);
			if (!exists && wikiWithRelated.some(w => w.id === relatedId)) {
				graphLinks.push({ source: wiki.id, target: relatedId });
			}
		});
	}
});
---

<!doctype html>
<html lang="ko" data-theme="dark">
	<head>
		<ViewTransitions />
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			html, body {
				overflow: hidden;
				height: 100vh;
			}
			body {
				display: flex;
				flex-direction: column;
			}
			.universe-container {
				flex: 1;
				position: relative;
				background: radial-gradient(ellipse at center, #0d0d1a 0%, #000008 100%);
				overflow: hidden;
			}
			/* 별 배경 */
			.stars {
				position: absolute;
				inset: 0;
				z-index: 0;
			}
			.star {
				position: absolute;
				background: #fff;
				border-radius: 50%;
				animation: twinkle var(--duration, 3s) ease-in-out infinite;
				animation-delay: var(--delay, 0s);
			}
			@keyframes twinkle {
				0%, 100% { opacity: var(--min-opacity, 0.3); transform: scale(1); }
				50% { opacity: 1; transform: scale(1.2); }
			}
			/* 은하수 효과 */
			.milky-way {
				position: absolute;
				top: 50%;
				left: 50%;
				width: 200%;
				height: 60%;
				transform: translate(-50%, -50%) rotate(-15deg);
				background: radial-gradient(ellipse, rgba(100, 100, 180, 0.08) 0%, transparent 60%);
				pointer-events: none;
				z-index: 0;
			}
			/* 성운 효과 */
			.nebula {
				position: absolute;
				border-radius: 50%;
				filter: blur(80px);
				opacity: 0.15;
				animation: nebula-pulse 20s ease-in-out infinite;
				z-index: 0;
			}
			.nebula-1 {
				width: 500px;
				height: 500px;
				background: radial-gradient(circle, rgba(138, 43, 226, 0.4) 0%, transparent 70%);
				top: 10%;
				left: 10%;
				animation-delay: 0s;
			}
			.nebula-2 {
				width: 400px;
				height: 400px;
				background: radial-gradient(circle, rgba(30, 144, 255, 0.3) 0%, transparent 70%);
				bottom: 20%;
				right: 15%;
				animation-delay: -7s;
			}
			.nebula-3 {
				width: 300px;
				height: 300px;
				background: radial-gradient(circle, rgba(255, 105, 180, 0.25) 0%, transparent 70%);
				top: 60%;
				left: 60%;
				animation-delay: -14s;
			}
			@keyframes nebula-pulse {
				0%, 100% { transform: scale(1) translate(0, 0); opacity: 0.15; }
				50% { transform: scale(1.1) translate(10px, -10px); opacity: 0.2; }
			}
		</style>
	</head>
	<body>
		<Header />
		<div class="universe-container">
			<div class="stars" id="stars"></div>
			<div class="milky-way"></div>
			<div class="nebula nebula-1"></div>
			<div class="nebula nebula-2"></div>
			<div class="nebula nebula-3"></div>
			<WikiGraph nodes={graphNodes} links={graphLinks} fullscreen={true} />
		</div>
		<Analytics />
		<script>
			// 별 생성
			function createStars() {
				const container = document.getElementById('stars');
				if (!container) return;
				container.innerHTML = '';
				const count = 150;
				for (let i = 0; i < count; i++) {
					const star = document.createElement('div');
					star.className = 'star';
					const size = Math.random() * 2 + 1;
					star.style.width = size + 'px';
					star.style.height = size + 'px';
					star.style.left = Math.random() * 100 + '%';
					star.style.top = Math.random() * 100 + '%';
					star.style.setProperty('--duration', (2 + Math.random() * 4) + 's');
					star.style.setProperty('--delay', Math.random() * 5 + 's');
					star.style.setProperty('--min-opacity', (0.2 + Math.random() * 0.3).toString());
					container.appendChild(star);
				}
			}
			createStars();
			document.addEventListener('astro:page-load', createStars);
		</script>
	</body>
</html>
