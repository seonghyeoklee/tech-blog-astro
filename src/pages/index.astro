---
import { getCollection } from 'astro:content';
import { ViewTransitions } from 'astro:transitions';
import Analytics from '@vercel/analytics/astro';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import WikiGraph from '../components/WikiGraph.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import fs from 'node:fs';
import path from 'node:path';

const wikiTerms = await getCollection('wiki');

// 위키 그래프 데이터 생성
const wikiDir = 'src/content/wiki';
const wikiWithRelated = wikiTerms.map(wiki => {
	try {
		const filePath = path.join(process.cwd(), wikiDir, `${wiki.id}.md`);
		const content = fs.readFileSync(filePath, 'utf-8');
		const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
		if (frontmatterMatch) {
			const relatedMatch = frontmatterMatch[1].match(/related:\s*\[(.*?)\]/);
			if (relatedMatch) {
				const related = relatedMatch[1].split(',').map(s => s.trim().replace(/['"]/g, '')).filter(Boolean);
				return { ...wiki, data: { ...wiki.data, related } };
			}
		}
	} catch (e) {}
	return { ...wiki, data: { ...wiki.data, related: [] } };
});

const graphNodes = wikiWithRelated.map(wiki => ({
	id: wiki.id,
	term: wiki.data.term,
	category: wiki.data.category,
	summary: wiki.data.summary,
}));

const graphLinks: { source: string; target: string }[] = [];
wikiWithRelated.forEach(wiki => {
	if (wiki.data.related && wiki.data.related.length > 0) {
		wiki.data.related.forEach((relatedId: string) => {
			const exists = graphLinks.some(
				link => (link.source === wiki.id && link.target === relatedId) ||
				        (link.source === relatedId && link.target === wiki.id)
			);
			if (!exists && wikiWithRelated.some(w => w.id === relatedId)) {
				graphLinks.push({ source: wiki.id, target: relatedId });
			}
		});
	}
});
---

<!doctype html>
<html lang="ko" data-theme="dark">
	<head>
		<ViewTransitions />
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<style>
			html, body {
				overflow: hidden;
				height: 100vh;
			}
			body {
				display: flex;
				flex-direction: column;
			}
			.universe-container {
				flex: 1;
				position: relative;
				background: radial-gradient(ellipse at center, #0d0d1a 0%, #000008 100%);
				overflow: hidden;
			}
			/* 별 배경 */
			.stars {
				position: absolute;
				inset: 0;
				z-index: 100;
				pointer-events: none;
			}
		</style>
		<style is:global>
			@keyframes twinkle {
				0%, 100% { opacity: var(--min-opacity, 0.3); transform: scale(1); }
				50% { opacity: 1; transform: scale(1.2); }
			}
		</style>
	</head>
	<body>
		<Header />
		<div class="universe-container">
			<div class="stars" id="stars"></div>
			<WikiGraph nodes={graphNodes} links={graphLinks} fullscreen={true} />
		</div>
		<Analytics />
		<script is:inline>
			function createStars() {
				const container = document.getElementById('stars');
				if (!container) return;
				container.innerHTML = '';
				const count = 150;
				for (let i = 0; i < count; i++) {
					const star = document.createElement('div');
					const size = Math.random() * 2 + 1;
					const duration = (2 + Math.random() * 4) + 's';
					const delay = Math.random() * 5 + 's';
					const minOpacity = 0.2 + Math.random() * 0.3;
					star.style.cssText = `
						position: absolute;
						background: #fff;
						border-radius: 50%;
						width: ${size}px;
						height: ${size}px;
						left: ${Math.random() * 100}%;
						top: ${Math.random() * 100}%;
						animation: twinkle ${duration} ease-in-out infinite;
						animation-delay: ${delay};
						--min-opacity: ${minOpacity};
					`;
					container.appendChild(star);
				}
			}

			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', createStars);
			} else {
				createStars();
			}
			document.addEventListener('astro:page-load', createStars);
		</script>
	</body>
</html>
