---
import { getCollection } from 'astro:content';
import { ViewTransitions } from 'astro:transitions';
import Analytics from '@vercel/analytics/astro';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import StructuredData from '../../components/StructuredData.astro';
import BlogCard from '../../components/BlogCard.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// 모든 태그 추출
const allTags = ['Java', 'Kotlin', 'Spring', 'Architecture', 'Database', 'MySQL', 'JPA', 'Redis', 'Kafka', 'Docker', 'Kubernetes', 'AWS', 'CS', 'OS', 'Network'];
---

<!doctype html>
<html lang="ko">
	<head>
		<ViewTransitions />
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<StructuredData
			type="website"
			title={`Blog - ${SITE_TITLE}`}
			description={SITE_DESCRIPTION}
			url={Astro.url}
		/>
		<style>
			main {
				width: 960px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 3em 1em;
			}

			/* 태그 필터 */
			.tag-filter {
				display: flex;
				justify-content: center;
				gap: 0.8em;
				margin-bottom: 2.5em;
				flex-wrap: wrap;
			}
			.filter-btn {
				padding: 0.5em 1.2em;
				border-radius: 20px;
				border: 2px solid rgb(var(--gray-light));
				background: transparent;
				cursor: pointer;
				font-size: 0.9em;
				font-weight: 600;
				transition: all 0.2s ease;
				color: rgb(var(--gray-dark));
			}
			.filter-btn:hover {
				border-color: var(--accent);
				color: var(--accent);
			}
			.filter-btn.active {
				background: var(--accent);
				border-color: var(--accent);
				color: white;
			}
			.filter-btn[data-tag="Java"].active {
				background: #f89820;
				border-color: #f89820;
			}
			.filter-btn[data-tag="Kotlin"].active {
				background: #7F52FF;
				border-color: #7F52FF;
			}
			.filter-btn[data-tag="Spring"].active {
				background: #6DB33F;
				border-color: #6DB33F;
			}
			.filter-btn[data-tag="Architecture"].active {
				background: #3498db;
				border-color: #3498db;
			}
			.filter-btn[data-tag="Database"].active {
				background: #336791;
				border-color: #336791;
			}
			.filter-btn[data-tag="MySQL"].active {
				background: #4479A1;
				border-color: #4479A1;
			}
			.filter-btn[data-tag="JPA"].active {
				background: #59666C;
				border-color: #59666C;
			}
			.filter-btn[data-tag="Redis"].active {
				background: #DC382D;
				border-color: #DC382D;
			}
			.filter-btn[data-tag="Kafka"].active {
				background: #231F20;
				border-color: #231F20;
			}
			.filter-btn[data-tag="Docker"].active {
				background: #2496ED;
				border-color: #2496ED;
			}
			.filter-btn[data-tag="Kubernetes"].active {
				background: #326CE5;
				border-color: #326CE5;
			}
			.filter-btn[data-tag="AWS"].active {
				background: #FF9900;
				border-color: #FF9900;
			}
			.filter-btn[data-tag="CS"].active {
				background: #6366F1;
				border-color: #6366F1;
			}
			.filter-btn[data-tag="OS"].active {
				background: #8B5CF6;
				border-color: #8B5CF6;
			}
			.filter-btn[data-tag="Network"].active {
				background: #06B6D4;
				border-color: #06B6D4;
			}

			/* 글 목록 - 그리드 레이아웃 */
			.post-grid {
				display: grid;
				grid-template-columns: repeat(4, 1fr);
				gap: 1.5em;
			}

			/* 빈 상태 */
			.empty-state {
				text-align: center;
				padding: 3em;
				color: rgb(var(--gray));
			}
			.empty-state p {
				font-size: 1.1em;
			}

			/* 글 개수 */
			.post-count {
				color: rgb(var(--gray));
				font-size: 0.9em;
				margin-bottom: 1em;
			}

			/* 반응형 그리드 레이아웃 */
			@media (max-width: 960px) {
				.post-grid {
					grid-template-columns: repeat(3, 1fr);
					gap: 1.25em;
				}
			}

			@media (max-width: 720px) {
				.post-grid {
					grid-template-columns: repeat(2, 1fr);
					gap: 1em;
				}
			}

			@media (max-width: 480px) {
				.post-grid {
					grid-template-columns: 1fr;
					gap: 1em;
				}
			}
		</style>
	</head>
	<body>
		<Header />
		<main>
			<!-- 태그 필터 -->
			<div class="tag-filter">
				<button class="filter-btn active" data-tag="all">All</button>
				{allTags.map((tag) => (
					<button class="filter-btn" data-tag={tag}>{tag}</button>
				))}
			</div>

			<!-- 글 목록 -->
			<section class="posts-section">
				<p class="post-count" id="post-count">{posts.length}개의 글</p>

				{posts.length === 0 ? (
					<div class="empty-state">
						<p>아직 작성된 글이 없습니다.</p>
					</div>
				) : (
					<div class="post-grid" id="post-grid">
						{posts.map((post, index) => (
							<BlogCard
								title={post.data.title}
								description={post.data.description}
								pubDate={post.data.pubDate}
								heroImage={post.data.heroImage}
								tags={post.data.tags}
								series={post.data.series}
								seriesOrder={post.data.seriesOrder}
								slug={post.id}
								index={index}
							/>
						))}
					</div>
				)}
			</section>
		</main>
		<Footer />

		<script>
			document.addEventListener('DOMContentLoaded', () => {
				const filterBtns = document.querySelectorAll('.filter-btn');
				const blogCards = document.querySelectorAll('.blog-card');
				const postCount = document.getElementById('post-count');

				filterBtns.forEach(btn => {
					btn.addEventListener('click', () => {
						// 버튼 활성화 상태 변경
						filterBtns.forEach(b => b.classList.remove('active'));
						btn.classList.add('active');

						const selectedTag = btn.getAttribute('data-tag');
						let visibleCount = 0;

						blogCards.forEach(card => {
							const cardTags = card.getAttribute('data-tags') || '';

							if (selectedTag === 'all' || cardTags.includes(selectedTag)) {
								(card as HTMLElement).style.display = 'flex';
								visibleCount++;
							} else {
								(card as HTMLElement).style.display = 'none';
							}
						});

						// 글 개수 업데이트
						if (postCount) {
							postCount.textContent = `${visibleCount}개의 글`;
						}
					});
				});
			});
		</script>
		<Analytics />
	</body>
</html>
