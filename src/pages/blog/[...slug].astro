---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BlogPost from '../../layouts/BlogPost.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import ReadingTime from '../../components/ReadingTime.astro';
import PostNavigation from '../../components/PostNavigation.astro';
import Quiz from '../../components/Quiz.astro';
import Comments from '../../components/Comments.astro';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	const sortedPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

	return sortedPosts.map((post, index) => ({
		params: { slug: post.id },
		props: {
			post,
			prevPost: sortedPosts[index + 1] ? { id: sortedPosts[index + 1].id, title: sortedPosts[index + 1].data.title } : null,
			nextPost: sortedPosts[index - 1] ? { id: sortedPosts[index - 1].id, title: sortedPosts[index - 1].data.title } : null,
		},
	}));
}

type Props = {
	post: CollectionEntry<'blog'>;
	prevPost: { id: string; title: string } | null;
	nextPost: { id: string; title: string } | null;
};

const { post, prevPost, nextPost } = Astro.props;
const { Content, headings } = await render(post);
---

<BlogPost {...post.data} headings={headings} rawContent={post.body || ''} slug={post.slug}>
	<TableOfContents headings={headings} />
	<Content />
	<PostNavigation prevPost={prevPost} nextPost={nextPost} />

	{post.data.quiz && post.data.quiz.length > 0 && (
		<>
			<div class="quiz-trigger-container">
				<button class="quiz-trigger-btn" id="quiz-trigger-btn">
					<span class="quiz-icon">üìù</span>
					<span class="quiz-text">
						<strong>Î≥µÏäµÌïòÍ∏∞</strong>
						<small>{post.data.quiz.length}Î¨∏Ï†ú Ï§ë 5Î¨∏Ï†ú</small>
					</span>
				</button>
			</div>
			<Quiz quizzes={post.data.quiz} />
		</>
	)}

	<Comments />
</BlogPost>

<style>
	/* ÌÄ¥Ï¶à Ìä∏Î¶¨Í±∞ Î≤ÑÌäº */
	.quiz-trigger-container {
		margin: 3em 0 2em 0;
		display: flex;
		justify-content: center;
	}

	.quiz-trigger-btn {
		display: flex;
		align-items: center;
		gap: 1.5em;
		padding: 1.5em 2.5em;
		background: linear-gradient(135deg, rgba(var(--accent-rgb, 91, 109, 255), 0.12) 0%, rgba(var(--accent-rgb, 91, 109, 255), 0.06) 100%);
		border: 2px solid rgba(var(--accent-rgb, 91, 109, 255), 0.3);
		border-radius: 16px;
		cursor: pointer;
		transition: all 0.3s ease;
		font-family: inherit;
	}

	.quiz-trigger-btn:hover {
		transform: translateY(-3px);
		box-shadow: 0 8px 24px rgba(var(--accent-rgb, 91, 109, 255), 0.25);
		border-color: rgba(var(--accent-rgb, 91, 109, 255), 0.5);
		background: linear-gradient(135deg, rgba(var(--accent-rgb, 91, 109, 255), 0.18) 0%, rgba(var(--accent-rgb, 91, 109, 255), 0.08) 100%);
	}

	.quiz-icon {
		font-size: 2.5em;
		line-height: 1;
	}

	.quiz-text {
		display: flex;
		flex-direction: column;
		gap: 0.25em;
		text-align: left;
	}

	.quiz-text strong {
		font-size: 1.2em;
		color: rgb(var(--black));
		font-weight: 700;
	}

	.quiz-text small {
		font-size: 0.9em;
		color: rgb(var(--gray));
	}

	@media (max-width: 640px) {
		.quiz-trigger-btn {
			padding: 1.25em 1.75em;
			gap: 1em;
		}

		.quiz-icon {
			font-size: 2em;
		}

		.quiz-text strong {
			font-size: 1em;
		}
	}
</style>

<script>
	// ÌÄ¥Ï¶à Î™®Îã¨ Ïó¥Í∏∞
	document.addEventListener('DOMContentLoaded', () => {
		const triggerBtn = document.getElementById('quiz-trigger-btn');
		const modalOverlay = document.getElementById('quiz-modal-overlay');

		triggerBtn?.addEventListener('click', () => {
			modalOverlay?.classList.add('active');
			document.body.style.overflow = 'hidden'; // Î∞∞Í≤Ω Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ
		});
	});
</script>
